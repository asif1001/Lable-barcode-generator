<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode PDF Generator</title>
</head>
<body>
    <h1>Upload Excel to Generate Barcode PDF</h1>
    
    <!-- Form to upload the Excel file -->
    <form id="upload-form" enctype="multipart/form-data">
        <input type="file" id="file" accept=".xlsx" required />
        <button type="button" onclick="uploadFile()">Upload and Generate PDF</button>
    </form>
    
    <!-- Div to show the status messages -->
    <div id="status-message" style="margin-top: 20px; font-weight: bold;"></div>

    <script>
        async function uploadFile() {
            const fileInput = document.getElementById("file");
            const statusMessage = document.getElementById("status-message");

            // Display "Uploading file..." message
            statusMessage.textContent = "Uploading file...";

            // Prepare the file data for upload
            const fileContent = await fileInput.files[0].arrayBuffer();
            const base64Content = btoa(String.fromCharCode(...new Uint8Array(fileContent)));

            // Replace with your GitHub token and username
            const response = await fetch(`https://api.github.com/repos/yourusername/barcode-generator/contents/uploads/${fileInput.files[0].name}`, {
                method: "PUT",
                headers: {
                    "Authorization": "token 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",  // Replace with your GitHub token
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: "Uploading Excel file",
                    content: base64Content
                })
            });

            // Log response for debugging
            const responseData = await response.json();
            console.log("Response status:", response.status);
            console.log("Response data:", responseData);

            if (response.ok) {
                // Display "File uploaded! Generating barcode PDF..." message
                statusMessage.textContent = "File uploaded! Generating barcode PDF...";
                await checkPDFStatus(statusMessage);
            } else {
                // Display the error message from GitHub
                statusMessage.textContent = `File upload failed: ${responseData.message}`;
            }
        }

        // Function to check if the PDF is generated
        async function checkPDFStatus(statusMessage) {
            const pdfFileName = document.getElementById("file").files[0].name.replace(".xlsx", ".pdf");
            const pdfUrl = `https://github.com/yourusername/barcode-generator/raw/main/output/${pdfFileName}`;

            const maxAttempts = 30;
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                const response = await fetch(pdfUrl, { method: "HEAD" });
                if (response.ok) {
                    statusMessage.innerHTML = `PDF is ready! <a href="${pdfUrl}" download>Download PDF</a>`;
                    return;
                }
                await new Promise(resolve => setTimeout(resolve, 10000)); // Check every 10 seconds
            }
            statusMessage.textContent = "PDF generation is taking longer than expected. Please check back later.";
        }
    </script>
</body>
</html>
